<%- include('../partials/header') %>

<section class="mb-4">
  <h2 class="section-title">Checkout</h2>

  <div class="checkout-container">
    <!-- Shipping Address -->
    <div class="checkout-section">
      <h3>Shipping Address</h3>

      <% if (addresses.length > 0) { %>
      <div class="addresses-list">
        <% addresses.forEach(address => { %>
        <div class="address-card" data-address-id="<%= address.address_id %>">
          <h4><%= address.address_type.toUpperCase() %> Address</h4>
          <p><%= address.street_address %></p>
          <p>
            <%= address.city %>, <%= address.state %> <%= address.zip_code %>
          </p>
          <p><%= address.country %></p>
        </div>
        <% }); %>
      </div>

      <input
        type="hidden"
        name="shipping_address_id"
        id="shipping_address_id"
        required
      />
      <% } else { %>
      <p>You don't have any addresses saved. Please add a shipping address.</p>
      <% } %>

      <div style="margin-top: 1.5rem">
        <button class="btn btn-outline" onclick="showAddAddressForm()">
          Add New Address
        </button>
      </div>

      <!-- Add address form -->
      <div
        id="add-address-form"
        class="hidden"
        style="
          margin-top: 1.5rem;
          padding: 1rem;
          border: 1px solid #dee2e6;
          border-radius: 4px;
        "
      >
        <h4>Add New Address</h4>

        <div class="form-group">
          <label class="form-label">Address Type</label>
          <select id="new_address_type" class="form-control">
            <option value="shipping">Shipping</option>
            <option value="billing">Billing</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Country</label>
          <input type="text" id="new_country" class="form-control" required />
        </div>

        <div class="form-group">
          <label class="form-label">State</label>
          <input type="text" id="new_state" class="form-control" required />
        </div>

        <div class="form-group">
          <label class="form-label">City</label>
          <input type="text" id="new_city" class="form-control" required />
        </div>

        <div class="form-group">
          <label class="form-label">Street Address</label>
          <input
            type="text"
            id="new_street_address"
            class="form-control"
            required
          />
        </div>

        <div class="form-group">
          <label class="form-label">Zip Code</label>
          <input type="text" id="new_zip_code" class="form-control" required />
        </div>

        <button class="btn" onclick="addNewAddress()">Save Address</button>
        <button class="btn btn-outline" onclick="hideAddAddressForm()">
          Cancel
        </button>
      </div>
    </div>

    <!-- Shipping Cost -->
    <div id="shipping-cost-section" class="form-group" style="margin-top: 1rem">
      <h4>Shipping</h4>
      <p id="shipping-cost">Select an address to calculate shipping...</p>
    </div>

    <!-- Order Summary -->
    <div class="checkout-section">
      <h3>Order Summary</h3>

      <div class="order-items">
        <% cartItems.forEach(item => { %>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
          "
        >
          <div>
            <h4><%= item.name %></h4>
            <p>Quantity: <%= item.quantity %></p>
          </div>
          <div>
            <p>$<%= (item.price * item.quantity).toFixed(2) %></p>
          </div>
        </div>
        <% }); %>
      </div>

      <div style="text-align: right; margin-top: 1.5rem">
        <p>Subtotal: $<span id="subtotal"><%= total.toFixed(2) %></span></p>
        <p>Shipping: $<span id="shipping-amount">0.00</span></p>
        <hr />
        <p style="font-size: 1.2rem; font-weight: bold">
          Total: $<span id="grand-total"><%= total.toFixed(2) %></span>
        </p>
      </div>

      <!-- Coupon -->
      <div class="form-group">
        <label class="form-label">Coupon Code</label>
        <input
          type="text"
          id="coupon_code"
          class="form-control"
          placeholder="Enter coupon"
          style="max-width: 200px"
        />
      </div>

      <!-- Payment Methods -->
      <div class="payment-method">
        <h3>Payment Method</h3>

        <div class="payment-option" data-method="credit_card">
          <input type="radio" name="payment_method" value="credit_card" />
          <label>Credit Card (via Stripe)</label>
        </div>

        <div class="payment-option" data-method="paypal">
          <input type="radio" name="payment_method" value="paypal" />
          <label>PayPal</label>
        </div>

        <div class="payment-option" data-method="mpesa">
          <input type="radio" name="payment_method" value="mpesa" />
          <label>M-Pesa</label>
        </div>

        <div class="payment-option" data-method="bank_transfer">
          <input type="radio" name="payment_method" value="bank_transfer" />
          <label>Bank Transfer</label>
        </div>

        <!-- PayPal Buttons -->
        <div
          id="paypal-button-container"
          class="hidden"
          style="margin-top: 1.5rem; min-height: 60px"
        ></div>

        <input type="hidden" id="payment_method" required />
      </div>

      <button
        id="place-order"
        class="btn"
        style="width: 100%; margin-top: 1.5rem; padding: 1rem"
      >
        Place Order
      </button>
    </div>
  </div>
</section>

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>

<!-- PayPal SDK (UNCHANGED) -->
<script
  src="https://www.paypal.com/sdk/js?client-id=<%= env.PAYPAL_CLIENT_ID %>&currency=USD&components=buttons"
  data-namespace="paypalCheckout"
></script>

<script>
  /* âœ… Improved PayPal readiness + safety */
  let paypalRendered = false; // Prevent double rendering

  function waitForPayPalSDK(callback, retries = 30) { // Increased retries
    if (
      window.paypalCheckout &&
      typeof window.paypalCheckout.Buttons === "function"
    ) {
      callback();
    } else if (retries > 0) {
      setTimeout(() => waitForPayPalSDK(callback, retries - 1), 200);
    } else {
      console.error("PayPal SDK failed to load after timeout");
      // Removed alert â€” too aggressive
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const paymentOptions = document.querySelectorAll(".payment-option");
    const paypalContainer = document.getElementById("paypal-button-container");
    const placeOrderBtn = document.getElementById("place-order");
    const shippingInput = document.getElementById("shipping_address_id");
    const paymentInput = document.getElementById("payment_method");

    let shippingCost = 0;
    const subtotal = parseFloat(
      document.getElementById("subtotal").textContent
    );

    function updateGrandTotal() {
      document.getElementById("grand-total").textContent = (
        subtotal + shippingCost
      ).toFixed(2);
    }

    paymentOptions.forEach((option) => {
      option.addEventListener("click", () => {
        const radio = option.querySelector("input");
        radio.checked = true;
        paymentInput.value = radio.value;

        // Reset UI
        paypalContainer.innerHTML = "";
        paypalContainer.classList.add("hidden");
        placeOrderBtn.style.display = "block";
        paypalRendered = false;

        if (radio.value === "paypal") {
          // ðŸ”’ CRITICAL VALIDATION
          if (!shippingInput.value || shippingInput.value === "") {
            alert("Please select or add a shipping address before choosing PayPal.");
            radio.checked = false;
            paymentInput.value = "";
            return;
          }

          if (subtotal <= 0) {
            alert("Your cart is empty or total is invalid.");
            radio.checked = false;
            paymentInput.value = "";
            return;
          }

          // Show PayPal container and render buttons
          placeOrderBtn.style.display = "none";
          paypalContainer.classList.remove("hidden");

          waitForPayPalSDK(() => {
            if (paypalRendered) return; // Safety

            paypalCheckout
              .Buttons({
                style: {
                  shape: "rect",
                  color: "gold",
                  layout: "vertical",
                  label: "paypal",
                },

                createOrder() {
                  return fetch("/api/paypal/create-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      shipping_address_id: shippingInput.value,
                      shipping_cost: shippingCost,
                      total_amount: parseFloat(
                        document.getElementById("grand-total").textContent
                      ).toFixed(2),
                    }),
                  })
                    .then((res) => {
                      if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                      }
                      return res.json();
                    })
                    .then((data) => {
                      if (!data.id) {
                        throw new Error("No order ID returned");
                      }
                      return data.id;
                    })
                    .catch((err) => {
                      console.error("Create order failed:", err);
                      alert("Failed to create PayPal order. Please try again.");
                      throw err; // Important: reject so PayPal doesn't proceed
                    });
                },

                onApprove(data) {
                  return fetch("/api/paypal/capture-order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ orderId: data.orderID }),
                  })
                    .then((res) => res.json())
                    .then((result) => {
                      if (result.success) {
                        window.location.href = "/account?order_success=true";
                      } else {
                        alert("Payment failed: " + (result.message || "Unknown error"));
                      }
                    })
                    .catch(() => {
                      alert("Failed to capture payment. Please contact support.");
                    });
                },

                onError(err) {
                  console.error("PayPal Buttons error:", err);
                  alert("PayPal payment error. Please try again.");
                },
              })
              .render("#paypal-button-container");

            paypalRendered = true;
          });
        }
      });
    });
  });

  // Show/hide add address form
  function showAddAddressForm() {
    document.getElementById("add-address-form").classList.remove("hidden");
  }

  function hideAddAddressForm() {
    document.getElementById("add-address-form").classList.add("hidden");
  }

  // Add new address function
  async function addNewAddress() {
    try {
      const addressData = {
        address_type: document.getElementById("new_address_type").value,
        country: document.getElementById("new_country").value,
        state: document.getElementById("new_state").value,
        city: document.getElementById("new_city").value,
        street_address: document.getElementById("new_street_address").value,
        zip_code: document.getElementById("new_zip_code").value,
      };

      // Validate required fields
      for (let key in addressData) {
        if (!addressData[key]) {
          alert("Please fill all address fields");
          return;
        }
      }

      const res = await fetch("/add-address", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(addressData),
      });

      const result = await res.json();

      if (result.success) {
        alert("Address added successfully!");
        location.reload();
      } else {
        throw new Error(result.message || "Failed to add address");
      }
    } catch (error) {
      console.error("Address error:", error);
      alert("Error adding address: " + error.message);
    }
  }
</script>

<%- include('../partials/footer') %>
