<%- include('../partials/header') %>

<section class="mb-4">
  <div class="container">
    <h2 class="section-title" style="color: #008000; text-align: center; font-weight: bold">
      M-Pesa Payment
    </h2>

    <div class="payment-form" style="background-color:white;padding:2rem;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.1);max-width:400px;margin:0 auto;">
      
      <!-- Phone Number -->
      <div class="form-group">
        <label class="form-label" style="display:block;margin-bottom:0.5rem;font-weight:bold;color:#333">
          Enter M-Pesa Phone Number
        </label>
        <input type="tel" id="phone_number" class="form-control" placeholder="254XXXXXXXXX" required style="width:100%;padding:0.75rem;border:1px solid #008000;border-radius:4px;font-size:1rem;">
        <small class="form-text" style="color:#666;font-size:0.85rem">Enter your phone number in the format: 254XXXXXXXXX</small>
      </div>

      <!-- Order Summary -->
      <div class="order-summary" style="margin:1.5rem 0;padding:1rem;background-color:#f0f0f0;border-radius:4px;border-left:4px solid #008000;">
        <h3 style="margin:0 0 0.5rem;color:#008000;font-size:1.2rem">Order Summary</h3>
        <p style="margin:0;font-weight:bold">Total Amount: KES <span id="ksh-display">Calculating...</span></p>
        <p id="rate-display" style="margin:0;font-size:0.8rem;color:#666;"></p>
      </div>

      <!-- Pay Button -->
      <button id="initiate-payment" class="btn" style="width:100%;margin-top:1.5rem;padding:1rem;background-color:#008000;color:white;border:none;border-radius:4px;font-size:1rem;font-weight:bold;cursor:pointer;transition:background-color 0.3s;" onmouseover="this.style.backgroundColor='#006400'" onmouseout="this.style.backgroundColor='#008000'">
        Pay with M-Pesa
      </button>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const kshDisplay = document.getElementById('ksh-display');
  const rateDisplay = document.getElementById('rate-display');
  const initiatePaymentBtn = document.getElementById('initiate-payment');
  const phoneInput = document.getElementById('phone_number');

  const usdAmount = <%= amount %>;
  let convertedKES = 0;

  // Fetch converted KES
  async function updateKshAmount() {
    try {
      const res = await fetch(`/api/mpesa/convert/${usdAmount}`);
      const data = await res.json();
      convertedKES = data.amountKES;
      kshDisplay.textContent = convertedKES.toLocaleString('en-US');
      rateDisplay.textContent = `Based on rate $1 â†’ KES ${(data.amountKES / usdAmount).toFixed(2)}`;
    } catch (err) {
      convertedKES = Math.ceil(usdAmount * 140);
      kshDisplay.textContent = convertedKES.toLocaleString('en-US') + ' (approx.)';
      rateDisplay.textContent = '';
    }
  }

  updateKshAmount();

  // Handle payment
  initiatePaymentBtn.addEventListener('click', async () => {
    const phone = phoneInput.value.trim();
    if (!phone || !phone.match(/^254\d{9}$/)) {
      alert('Enter a valid phone number in the format: 254XXXXXXXXX');
      return;
    }

    try {
      initiatePaymentBtn.disabled = true;
      initiatePaymentBtn.textContent = 'Processing...';

      const response = await fetch('/api/mpesa/pay', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          phone,
          amount: usdAmount,
          accountReference: '<%= orderId %>'
        })
      });

      const data = await response.json();
      if (data.ResponseCode === "0") {
        alert('STK Push sent! Check your phone to complete payment.');
        window.location.href = '/payment-success';
      } else {
        throw new Error(data.errorMessage || 'Payment initiation failed');
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('Error: ' + error.message);
    } finally {
      initiatePaymentBtn.disabled = false;
      initiatePaymentBtn.textContent = 'Pay with M-Pesa';
    }
  });
});
</script>

<%- include('../partials/footer') %>
